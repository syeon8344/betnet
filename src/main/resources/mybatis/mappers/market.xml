<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- xml 주석 -->
<mapper namespace="web.model.dao.MarketDao" > <!-- mapper start -->

    <!-- 1. 글 불러오기 (+ 검색어, 거래상태) -->
    <select id="mkReadAll" resultType="web.model.dto.MarketDto">
        select * from market inner join members on market.mkwriter = members.memberid
        <where>
            <if test="mkstate > 0">
                and mkstate = #{mkState}
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                and mktitle like concat('%', #{searchKeyword}, '%')
            </if>
        </where>
        order by mkid desc limit #{startRow}, #{pageSize};
    </select>

    <!-- 1-1. 게시판 페이지화) 총 게시글 수 검색 -->
    <select id="getTotalBoardSize" resultType="int">
        select count(*) from market inner join members on market.mkwriter = members.memberid
        <where>
            <if test="mkstate > 0">
                and mkstate = #{mkState}
            </if>
            <if test="searchKeyword != null and searchKeyword != ''">
                and mktitle like concat('%', #{searchKeyword}, '%')
            </if>
        </where>
    </select>

    <!-- 4. 상세 페이지 조회수 증가 -->
    <update id="mkView" parameterType="web.model.dto.MarketDto">
        update market set mkview = mkview + 1 where mkid = #{mkid}
    </update>

    <!-- 5. 글 수정/삭제 권한 확인 -->
    <select id="mkCheck" parameterType="web.model.dto.MarketDto">
        select mkid from market where mkid = mkId and mkwriter = memberId;
    </select>




<!--    &lt;!&ndash; 5. 글 수정/삭제 권한 확인 &ndash;&gt;-->
<!--    <select id="pointBuy" resultType="web.model.dto.PointLogDto">-->
<!--        select * from PointLogs inner join members on PointLogs.memberid = members.memberid where Description = 1 order by logdate desc;-->
<!--    </select>-->

    <!-- 6. 글 수정하기 (거래완료 제외) -->
    <update id="mkEdit" parameterType="web.model.dto.MarketDto">
        update market set mktitle = #{mktitle}, mkcontent = #{mkcontent}, mkstate = #{mkstate}
        where mkid = #{mkid} and mkwriter = #{memberid};
    </update>

    <!-- 7. 글 삭제하기 (거래완료 제외) -->
    <delete id="mkDelete" parameterType="map">
        delete from market where mkwriter = #{memberId} and mkid = #{mkId};
    </delete>

    <!-- 8. 게시물 댓글 작성 -->
    <update id="mkWriteReply" parameterType="web.model.dto.MarketDto">
        update market set mktitle = #{mktitle}, mkcontent = #{mkcontent}, mkstate = #{mkstate}
        where mkid = #{mkid} and mkwriter = #{memberid};
    </update>

</mapper> <!-- mapper end -->

